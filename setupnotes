* Start:

install AsteriskNOW 2.0.2 distribution with freepbx
update modules with gui module administration
start/stop asterisk with /etc/init.d/asterisk

* Addresses and ports:

forward ports on router:
5060-5070 udp (only 5060 is needed for 1 connection)
10000-20000 udp

edit sip_nat.conf:
externip=<external IP>
localnet=<ip/mask>
nat=yet
then restart console, or sip reload sip_nat.conf

* Get callcentic DID
https://my.callcentric.com/home.php

* Setup SIP trunk for incoming route:

Using callcentric DID.
https://my.callcentric.com/how_to_start.php?pid=3&device=15&go.x=113&go.y=15&go=Continue
No config at callcentric site.
Disable all existing trunks.

In freepbx gui, connectivity->trunks->add SIP trunk
trunk name: callcentric
outgoing settings:
"""
trunk name: calcentric
peer details:
context=from-pstn
fromdomain=callcentric.com
fromuser=<callcentric-1777-moderator-number>
host=callcentric.com
insecure=port,invite
secret=<password>
type=peer
defaultuser=<callcentric-1777-moderator-number>
disallowed_methods=UPDATE
directmedia=no
videosupport=no
disallow=all
allow=ulaw
"""
note: use callcentric moderator 1777 moderator number, not phone number!
incoming settings: blank
register string: <callcentric-1777-moderator-number>:<password>@callcentric.com/<callcentric-1777-moderator-number>

edit sip_general_custom.conf
context=from-pstn
srvlookup=yes
session-timers=refuse
session-expires=180
session-minse=90
session-refresher=uas 

sip show peers to verify
phone should now be registered at callcentric site

* note we skipped outbound route configuration for now
* note we skipped adding an extension for now

* Setup incoming route
Description: from-callcentric
Everyting else should be blank
(callcentric says use the 1777 moderator number, do that if we want more than
one incoming route)
Add a destination for testing (like the clock)


---
old setup notes

pap2: (sip device)
extension 666, 777
set proxy, outbound proxy address to asterisk box IP
old way: ext to direct dial to 7777 dial plan: S0<:7777>
- causes simulate inbound
- but this takes up the inbound line
new way: ext to direct dial to 1002
set up 1002 extensions in extensions_custom.conf to go to ivr

freepbx:
/etc/asterisk/extensions_override_freepbx.conf - external sip info
asterisk -r to attach
extensions (sip devices)
- 666, 777
- sip show peers
trunk
- flowroute trunk
-- XXX lots of config here, but should be in repo
-- XXX do we need an ipkall trunk to register?
- callcentric trunk, see below
inbound route
- ipkall-1
-- set destination ivr
-- then incoming 7777 from sip device will go here immediately
outbound route
- single route going to flowroute?


ipkall:
ipkall is incoming sip and did only
phone.ipkall.com
update ip address in web ui to external ip of asterisk box
update name of sip uri to ipkall-1 to match extension_override_freepbx.conf

flowroute:
flowroute is outgoing sip only
no config at flowroute site




asterisk feature code? to call specific number
extensions_custom.conf
(replace XXXDESTINATION)
  [from-internal-custom]
  include => 999
  include => 1000

  [999]
  exten => 999,1,Playback(demo-congrats)
  exten => 999,2,Hangup()

  [1000]
  exten => 1000,1,Dial(SIP/flowroute/XXXDESTINATION,300,)
  exten => 1000,2,Hangup()

IVR:

copy media to /var/lib/asterisk/sounds/custom
can use subdirectory
add with gui


notes
don't forget to chown/chgrp asterisk

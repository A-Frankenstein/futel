* Start:

install AsteriskNOW 2.0.2 distribution with freepbx
install rhel (asteriskNOW is centos 5 based)
update modules with gui module administration
start/stop asterisk with /etc/init.d/asterisk

* Addresses and ports:

forward ports on router:
5060-5070 udp (only 5060 is needed for 1 connection)
10000-20000 udp

edit sip_nat.conf:
externhost=<dyndns address>
localnet=<ip/mask>
nat=yes
then restart console, or sip reload sip_nat.conf
if we have a static IP, use externip instead of externhost

* dyndns client
get a dyndns account for the box
yum install inadyn
edit /etc/inadyn.conf
chkconfig --add inadyn
chkconfig inadyn on


* Get callcentic DID
https://my.callcentric.com/home.php
 
* Setup SIP trunk for incoming route:

Using callcentric DID.
https://my.callcentric.com/how_to_start.php?pid=3&device=15&go.x=113&go.y=15&go=Continue
No config at callcentric site.
Disable all existing trunks.

In freepbx gui, connectivity->trunks->add SIP trunk
trunk name: callcentric
outgoing settings:
"""
trunk name: callcentric
peer details:
context=from-pstn
fromdomain=callcentric.com
fromuser=<callcentric-1777-moderator-number>
host=callcentric.com
insecure=port,invite
secret=<password>
type=peer
defaultuser=<callcentric-1777-moderator-number>
disallowed_methods=UPDATE
directmedia=no
videosupport=no
disallow=all
allow=ulaw
"""
note: use callcentric moderator 1777 moderator number, not phone number!
incoming settings: blank
register string: <callcentric-1777-moderator-number>:<password>@callcentric.com/<callcentric-1777-moderator-number>

edit sip_general_custom.conf
context=from-pstn
srvlookup=yes
session-timers=refuse
session-expires=180
session-minse=90
session-refresher=uas 

sip show peers to verify
phone should now be registered at callcentric site

* note we skipped outbound route configuration for now
* note we skipped adding an extension for now

* Setup incoming route
Description: from-callcentric
Everyting else should be blank
(callcentric says use the 1777 moderator number, do that if we want more than
one incoming route)
Add a destination for testing (like the clock)

* Add an extension for a phone device (sip peer)
applications->add extension->generic SIP device
user extension 666
display name 666
secret <password>
nat yes

* add an extension 1002 for the phone device destination
we do a demo IVR for testing 
edit extensions_custom.conf
[from-internal-custom]
include => demo-menu
include => 1002

[demo-menu]
exten => s,1,Answer(500)
   same => n(loop),Background(press-1&or&press-2)
   same => n,WaitExten()

exten => 1,1,Playback(you-entered)
   same => n,SayNumber(1)
   same => n,Goto(s,loop)

exten => 2,1,Playback(you-entered)
   same => n,SayNumber(2)
   same => n,Goto(s,loop)

[1002]
   exten => 1002,1,Goto(demo-menu,s,1)



* Setup PAP device (linksys spa3000)
login as admin, advanced view
voice->line1
nat mapping enable yes
proxy: asterisk box IP visible to pap device
outbound proxy: asterisk box IP visible to pap device
user ID: SIP extention number
password: SIP extension secret
dial string S0<:1002>
- this means call ext 1002
may need to restart the device
- asterisk console should give a message peer 666 now reachable
- pick up the phone, get the expected destination


---
old setup notes

freepbx:
/etc/asterisk/extensions_override_freepbx.conf - external sip info
asterisk -r to attach
trunk
- flowroute trunk
-- XXX lots of config here, but should be in repo
-- XXX do we need an ipkall trunk to register?
- callcentric trunk, see below
inbound route
- ipkall-1
-- set destination ivr
-- then incoming 7777 from sip device will go here immediately
outbound route
- single route going to flowroute?


ipkall:
ipkall is incoming sip and did only
phone.ipkall.com
update ip address in web ui to external ip of asterisk box
update name of sip uri to ipkall-1 to match extension_override_freepbx.conf

flowroute:
flowroute is outgoing sip only
no config at flowroute site




asterisk feature code? to call specific number
extensions_custom.conf
(replace XXXDESTINATION)
  [from-internal-custom]
  include => 999
  include => 1000

  [999]
  exten => 999,1,Playback(demo-congrats)
  exten => 999,2,Hangup()

  [1000]
  exten => 1000,1,Dial(SIP/flowroute/XXXDESTINATION,300,)
  exten => 1000,2,Hangup()

IVR:

copy media to /var/lib/asterisk/sounds/custom
can use subdirectory
add with gui


notes
don't forget to chown/chgrp asterisk

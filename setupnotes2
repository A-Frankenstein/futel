*** set up asterisk on centos 6 without freepbx

* install centos 6.x

* add users and access
useradd -m karl -s /bin/bash -G wheel -u 666 # etc
# uncomment wheel access in /etc/sudoers
# edit /etc/ssh/sshd_config
# Port
# PermitRootLogin no
# AllowX11Forwarding no
# SetPermitTunnel yes
# RSAAuthentication yes
# PubKeyAuthentication no
# PasswordAuthentication no

* kill firewall for now, fix it later
iptables -F
chkconfig --del iptables

* setup centos
yum groupremove "FCoE Storage Client"
yum groupremove "iSCSI Storage Client"
yum groupremove "Network file system client"
yum groupremove "Storage Availability Tools"
yum remove audit rpcbind selinux-policy selinux-policy-targeted
yum update

yum install man
yum install vim-enhanced gcc gcc-g++ make automake libtool autoconf
yum install mlocate lynx cvs git subversion strace ltrace wget lsof tcpdump
yum install openssh openssh-server openssh-clients
yum install openssl-devel
yum install ncurses-devel libxml2-devel newt-devel kernel-devel sqlite-devel
yum install libuuid-devel

* install epel
su -c 'rpm -Uvh http://download.fedoraproject.org/pub/epel/6/i386/epel-release-6-8.noarch.rpm'

* add non-root user for asterisk
useradd -m asterisk -s /bin/false

* make sure hostname is in /etc/hosts
127.0.0.1 ceres

* build, install asterisk from source
as asterisk
cd /usr/local/src/asterisk-11.5.1
mkdir /opt/asterisk
chown/chgrp asterisk /opt/asterisk
#su asterisk?
./configure --libdir=/usr/lib64 --prefix=/opt/asterisk --sysconfdir=/opt/asterisk
  --localstatedir=/opt/asterisk
make menuselect # just do this and exit
make
make install
#exit # back to root?
make samples
make config #as root
edit /opt/asterisk/sbin/safe_asterisk ASTARGS="-U asterisk"

# test with console: /opt/asterisk/sbin/asterisk -r

* set up a q&d backups for when we fuck up
# backup asterisk!
tar -zc /opt/asterisk -f /opt/asterisk.tgz
# put /opt/asterisk/asterisk in a git repo, hope there are no keys in there!

* install pyst:
  (note that pystrix might be a more modern python AGI implemention)
  http://pyst.sourceforge.net/ https://pypi.python.org/pypi/pyst
  cd /usr/local/src/pyst...
  python setup.py install --prefix=/usr/local
  # I don't think we need to do this anymore
  # ln -s /usr/local/lib/python2.6/site-packages/asterisk/ /usr/lib/python2.4/site-packages/

* install dyndns client
get a dyndns account for the box
http://dyn.com/support/clients/linux/inadyn/
XXX dyndns is bogus, get a better service.
download, build, install inadyn
cp bin/linux/inadyn /usr/local/sbin/
edit /etc/inadyn.conf
add /etc/init.d/inadyn
http://pastebin.com/7jnh340e
create links in /etc/rc.d/* (or get chkconfig to work)
Note that if inadyn stops working, dhcp breaks!  Try signing in to dyndns and
then restarting networking on the box if that happens.

* XXX remove the firewall again? should figire this out, or better yet, figure
  out how we can keep it
iptables -F
chkconfig --del iptables

* Addresses and ports:

forward ports on router:
5060-5070 udp (only 5060 is needed for 1 connection)
10000-20000 udp

edit sip.conf:
externhost=<dyndns address>
localnet=<ip/mask> # eg 10.0.0.0/255.255.255.0
nat=force_rport,comedia ;yes 
#then restart console, or sip reload sip_nat.conf
#if we have a static IP, use externip instead of externhost

* Get callcentic DID
https://my.callcentric.com/home.php
preferences:
outbound simultaneous calls: multiple
max call duration: 30 minutes (or whatever)

* Setup SIP trunk for an outgoing route with callcentric DID
#https://my.callcentric.com/how_to_start.php?pid=1

# edit sip.conf
# include a file with secrets
#include sip_callcentric.conf
# add general options
# this probably prevents using other DIDs
# XXX This assumes extension 666, does this require anything in the pap device?
#     Are we using channel 666 for an outgoing extension?
[general]
context=from-callcentric
session-timers=refuse
[666]
context=to-callcentric
type=friend
username=666
host=dynamic

# edit sip_callcentric.conf
# DO NOT CHECK THIS IN, THIS IS THE CALLCENTRIC SECRETS FILE
[general](+)
register => XXX:XXX@callcentric.com
[callcentric](+)
defaultuser=XXX
fromuser=XXX
secret=XXX
[666](+)
secret=XXX

# test:
# sip reload sip.conf
# sip show registry
# sip show peers

* Setup SIP trunk for an incoming route with callcentric DID
#https://my.callcentric.com/how_to_start.php?pid=1

# edit extensions.conf
[from-callcentric]
exten => s,1,Dial(SIP/123)

[to-callcentric]
exten => _XX,1,Dial(SIP/${EXTEN}@callcentric)

# test:
# callcentric click2dial with the callcentric web UI

* general testing:
/opt/asterisk/sbin/asterisk -r for console
core restart gracefully

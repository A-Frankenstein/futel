*** set up asterisk on centos 6 box

** acquire external services

* external:
* Get callcentic DID
https://my.callcentric.com/home.php
preferences:
outbound simultaneous calls: multiple
max call duration: 30 minutes (or whatever)

* external:
* Get callcentric free phone number
XXX do we need to log in to the web or call the number monthly to keep it?

* external:
* get a dyndns account for the box
http://dyn.com/support/clients/linux/inadyn/
XXX dyndns is bogus, get a better service.
	dyndns is going away... 04/07/14
    NameCheap is the futel.net registrar, they have something.
    DigitalOcean uses static IPs, so we only have to update if we start up
    a droplet.

** set up box

* install centos 6.x

* add users and access
useradd -m karl -s /bin/bash -G wheel -u 666 # etc
# uncomment wheel access in /etc/sudoers
# edit /etc/ssh/sshd_config
# Port
# PermitRootLogin no
# AllowX11Forwarding no
# SetPermitTunnel yes
# RSAAuthentication yes
# PubKeyAuthentication no
# PasswordAuthentication no

* kill firewall for now, fix it later
iptables -F
chkconfig --del iptables

* setup centos
yum groupremove "FCoE Storage Client"
yum groupremove "iSCSI Storage Client"
yum groupremove "Network file system client"
yum groupremove "Storage Availability Tools"
yum remove audit rpcbind selinux-policy selinux-policy-targeted
yum update

yum install man
yum install vim-enhanced gcc gcc-g++ make automake libtool autoconf
yum install mlocate lynx cvs git subversion strace ltrace wget lsof tcpdump
yum install openssh openssh-server openssh-clients
yum install openssl-devel
yum install ncurses-devel libxml2-devel newt-devel kernel-devel sqlite-devel
yum install libuuid-devel
yum install festival # if running festival locally

* install epel
su -c 'rpm -Uvh http://download.fedoraproject.org/pub/epel/6/i386/epel-release-6-8.noarch.rpm'

* add non-root user for asterisk
useradd -m asterisk -s /bin/false

* make sure hostname is in /etc/hosts
127.0.0.1 ceres

XXX VPN setup? no more inadyn

* install pyst:
  (note that pystrix might be a more modern python AGI implemention)
  http://pyst.sourceforge.net/ https://pypi.python.org/pypi/pyst
  cd /usr/local/src/pyst...
  python setup.py install --prefix=/usr/local
  # I don't think we need to do this anymore
  ln -s /usr/local/lib/python2.6/site-packages/asterisk/ /usr/lib/python2.6/site-packages/

* setup festival server
# XXX this is not exactly safe
# edit /etc/rc.d/rc.local
su -s /bin/bash nobody -c '/usr/bin/festival --server &'
# XXX add to chkconfig to start on boot?

* build, install asterisk from source
as asterisk
cd /usr/local/src/asterisk-11.5.1
mkdir /opt/asterisk
chown/chgrp asterisk /opt/asterisk
#su asterisk?
./configure --libdir=/usr/lib64 --prefix=/opt/asterisk --sysconfdir=/opt/asterisk
  --localstatedir=/opt/asterisk
make menuselect # just do this and exit
make
make install
#exit # back to root?
make samples
make config #as root
edit /opt/asterisk/sbin/safe_asterisk ASTARGS="-U asterisk"

# test with console: /opt/asterisk/sbin/asterisk -r
# core restart gracefully

* XXX remove the firewall again? should figire this out, or better yet, figure
  out how we can keep it
iptables -F
chkconfig --del iptables

* external:
* forward ports on router if necessary:
5060-5070 udp (only 5060 is needed for 1 connection)
10000-20000 udp

* clone the git repo into /opt/asterisk/asteris
git clone git@github.com:kra/futel-ceres-opt-asterisk-asterisk.git
* clone the git repo into var/lib/asterisk/agi-bin
git clone git@github.com:lboom/futel-ceres-opt-asterisk-var-lib-asterisk-agi-bin.git

* edit sip.conf to match repo
might need tweaking for externhost, localnet
# then restart console, or sip reload sip_nat.conf
#if we have a static IP, use externip instead of externhost

* Setup SIP trunk for an outgoing route with callcentric DID
#https://my.callcentric.com/how_to_start.php?pid=1

# edit sip_callcentric.conf
# DO NOT CHECK THIS IN, THIS IS THE CALLCENTRIC SECRETS FILE
[general](+)
register => XXX:XXX@callcentric.com
[callcentric](+)
defaultuser=XXX
fromuser=XXX
secret=XXX

; context for a sip user ie pap device
[666](+)
secret=XXX

[667]
; repeat for each sip user 

# test:
# sip reload sip.conf
# sip show registry
# sip show peers

# edit extensions_secret.conf

* external:
# test:
# callcentric click2dial with the callcentric web UI
# call the callcentric number from a phone

* external:
# set up PAP device
# VERY basic spa-3000(basically any PAP device) setup:
# always login as admin, set view to advanced
# XXX need to add password on the PAP
# make sure DHCP feature is turned off, why why why
primary ntp server north-america.pool.ntp.org
# some spa settings
sip port=5060 # any available, not sure if this needs to be set, can share?
proxy=XXX # domain name of asterisk server
outbound proxy=XXX # same as proxy
use outbound proxy=yes
register=yes
nat mapping enable=yes
userID=666 # example configuration above in sip_callcentric.conf
password=XXX_secret
# some dial strings below:
# straight out, dials extension automatically
# we probably want this - send user to extension 999
S0<:999>
# the default string can be useful for testing
# this has lag
#*xx|[3469]11|0|00|[2-9]xxxxxx|1xxx[2-9]xxxxxxS0|xxxxxxxxxxxx

# now spa-3000 sends user to extension 999 as user 666
# sip.conf says user 666 is the to-callcentric extension
# extensions.conf says what to do when 999 called in the to-callcentric context

* external:
# test:
# pick up the pap device phone, get a dial tone provided by the pap
# pap says you are extension 666
# sip.conf puts us in in context 666 / to-callcentric
# to-callcentric says what we can do - e.g. extensions dialable

# perform ops doc actions
* perform voicemail doc actions
